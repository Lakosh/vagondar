{% extends 'main/layout.html' %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="{% static 'main/css/index.css' %}">

<div id="addWagon" class="modal">
    <div class="modal-content">
        <h1>Добавление вагона:</h1>
        <form method="post" action="{% url 'main' %}" style="margin: 5px">
            {% csrf_token %}
            <p>Номер вагона</p>
            {{ add_wagon_form.wagon_number }}
            <p>Направление</p>
            {{ add_wagon_form.destination }}
            <p>Заметка</p>
            {{ add_wagon_form.notes }}
            <input type="hidden" name="event_id" id="id_event_id" value="">
            <input type="hidden" name="action_type" value="">
            <br>
            <button class="btn btn-success">Добавить</button>
        </form>
        <button class="btn btn-danger" onclick="closeModal('addWagon')">Закрыть</button>
    </div>
</div>

<div id="addDestination" class="modal">
    <div class="modal-content">
        <h1>Добавление направления:</h1>
        <form method="post" action="{% url 'main' %}" style="margin: 5px">
            {% csrf_token %}
            <p>Название предприятия:</p>
            {{ add_destination_form.name }}
            <p>Расстояние:</p>
            {{ add_destination_form.distance_km }}
            <br>
            <br>
            <input type="hidden" name="action_type" value="">
            <button class="btn btn-success">Добавить</button>
        </form>
        <button class="btn btn-danger" onclick="closeModal('addDestination')">Закрыть</button>
    </div>
</div>

<div id="addEvent" class="modal">
    <div class="modal-content">
        <h1>Добавить событие:</h1>
        <form action="{% url 'main' %}" method="post" style="margin: 5px">
            {% csrf_token %}
            <p>Тип события:</p>
            {{ add_event_form.operation_type }}
            <p>Дата события:</p>
            {{ add_event_form.event_date }}
            <p>Время события:</p>
            {{ add_event_form.event_time }}
            <p>Тариф:</p>
            {{ add_event_form.tariff }}
            <p>Заметка (необязательно):</p>
            {{ add_event_form.notes }}
            <br>
            <br>
            <input type="hidden" name="action_type" value="">
            <button class="btn btn-success">Добавить</button>
        </form>
        <button class="btn btn-danger" onclick="closeModal('addEvent')">Закрыть</button>
    </div>
</div>

<div id="editEvent" class="modal">
    <div class="modal-content">
        <h1>Изменить событие:</h1>
        <form action="{% url 'main' %}" method="post" style="margin: 5px">
            {% csrf_token %}
            {{ add_event_form.as_p }}
            <input type="hidden" name="action_type" value="edit_event">
            <input type="hidden" name="event_id" id="editEventId">
            <button class="btn btn-success">Сохранить</button>
        </form>
        <button class="btn btn-danger" onclick="closeModal('editEvent')">Закрыть</button>
    </div>
</div>

<div id="addTariff" class="modal">
    <div class="modal-content">
        <h1>Добавить тариф:</h1>
        <form action="{% url 'main' %}" method="post" style="margin: 5px">
            {% csrf_token %}
            {{ add_tariff_form.as_p }}
            <input type="hidden" name="action_type" value="">
            <button class="btn btn-success">Добавить</button>
        </form>
        <button class="btn btn-danger" onclick="closeModal('addTariff')">Закрыть</button>
    </div>
</div>

<div id="editWagon" class="modal">
    <div class="modal-content">
        <h1>Изменить вагон:</h1>
        <form action="{% url 'main' %}" method="post" style="margin: 5px">
            {% csrf_token %}
            {{ add_wagon_form.as_p }}
            <input type="hidden" name="action_type" value="edit_wagon">
            <input type="hidden" name="wagon_id" id="editWagonId">
            <button class="btn btn-success">Сохранить</button>
        </form>
        <button class="btn btn-danger" onclick="closeModal('editWagon')">Закрыть</button>
    </div>
</div>

<div id="exportExcel" class="modal">
    <div class="modal-content">
        <h1>Экспорт в excel:</h1>
        <form action="{% url 'main' %}" method="get" style="margin: 5px">
            {% csrf_token %}
            <input type="hidden" name="export" value="1">
            <input type="hidden" name="event_id" value="">
            <button class="btn btn-success">Экспортировать событие в Excel</button>
            <br>
            <br>
        </form>
        <button class="btn btn-danger" onclick="closeModal('exportExcel')">Закрыть</button>
    </div>
</div>


<div id="exportExcelDate" class="modal">
    <div class="modal-content">
        <h1>Экспорт в excel:</h1>
        <form action="{% url 'main' %}" method="get" style="margin: 5px">
            {% csrf_token %}
            <input type="hidden" name="export" value="2">
            <input type="date" name="start_date">
            <input type="date" name="end_date">
            <select name="operation_type">
                <option value="arrival">Пригон</option>
                <option value="removal">Уборка</option>
            </select>
            <br>
            <br>
            <button class="btn btn-success">Экспортировать событие в Excel</button>
        </form>
        <button class="btn btn-danger" onclick="closeModal('exportExcelDate')">Закрыть</button>
    </div>
</div>

{% for event in events %}
<div class="card my-3">
    <div class="card-header">
        <div>
            {% if event.operation_type == "arrival" %}
            <strong>Тип операции:</strong> Пригон<br>
            {% elif event.operation_type == "removal" %}
            <strong>Тип операции:</strong> Уборка<br>
            {% endif %}
            <strong>Тариф:</strong> {{ event.tariff.tariff }} ₸ <br>
            <strong>Дата:</strong> {{ event.event_date }} <br>
            <strong>Время:</strong> {{ event.event_time }} <br>
            <strong>Количество вагонов:</strong> {{ event.wagons.all|length }} <br>
            <strong>Итоговый объем:</strong> {{ event.total_vol|floatformat:3 }} <br>
            <strong>Сумма итого:</strong> {{ event.total_price|floatformat:2 }}
        </div>
        <div>
            <button class="btn btn-success" onclick="openModal('addWagon', {{ event.id }})">Добавить вагон</button>
            <button class="btn btn-info" type="button" onclick="openEditEvent({{ event.id }})">Изменить данные</button>
            <form method="post" action="{% url 'delete_event' event.id %}" style="display: inline">
                {% csrf_token %}
                <button class="btn btn-danger" type="submit" onclick="return confirm('Удалить это событие?')">Удалить
                    событие
                </button>
            </form>
            <button class="btn btn-secondary" onclick="openExportToExcel({{ event.id }})">Экспортировать событие
            </button>

        </div>
    </div>
    <div class="card-body">
        <strong>Вагоны:</strong>
        <div class="table-wrap">
            <table class="striped-table">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Направление</th>
                    <th>№ вагона</th>
                    <th>Протяженность 1</th>
                    <th>Протяженность 2</th>
                    <th>Протяженность 3</th>
                    <th>Объем за вагон</th>
                    <th>Обьем за локоматив</th>
                    <th>Итого обьем</th>
                    <th>Итого</th>
                    <th>Действия</th>
                </tr>
                </thead>

                <tbody>
                {% for wagon in event.wagons.all %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ wagon.destination.name }}</td>
                    <td>{{ wagon.wagon_number }}</td>
                    <td>{{ wagon.distance_1|floatformat:3 }}</td>
                    <td>{{ wagon.distance_2|floatformat:3 }}</td>
                    <td>{{ wagon.distance_3|floatformat:3 }}</td>
                    <td>{{ wagon.dist_sum|floatformat:3 }}</td>
                    <td>{{ wagon.vol_per_loko|floatformat:3 }}</td>
                    <td>{{ wagon.total_vol_per_wagon|floatformat:3 }}</td>
                    <td>{{ wagon.wagon_p_sum|floatformat:2 }}</td>
                    <td>
                        <div class="actions">
                            <form method="post" action="{% url 'delete_wagon' wagon.id %}">
                                {% csrf_token %}
                                <button class="btn btn-danger btn-sm" type="submit"
                                        onclick="return confirm('Удалить вагон: {{ wagon.destination.name }}: {{ wagon.wagon_number }}?')">
                                    Удалить
                                </button>
                            </form>
                            <button class="btn btn-success btn-sm" onclick="openEditWagon({{ wagon.id }})">
                                Изменить
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="empty-row">Вагонов нет</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>
<script src="{% static 'main/js/script.js' %}"></script>
{% endfor %}
{% endblock %}
